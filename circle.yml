machine:
  environment:
    BRANCH: $( echo $CIRCLE_BRANCH | awk -Ffeature/ '/feature/{print $2}' | tr '[:upper:]' '[:lower:]' )
  node:
    version: 7.5.0
  services:
    - docker

general:
  artifacts:
    - "./coverage"

dependencies:
  cache_directories:
    - ~/.cache/yarn
  override:
    - yarn

test:
  override:
    - yarn test

deployment:
  dev:
    branch: develop
    commands:
      - npm run builddocker
      - docker build -f docker/Dockerfile -t 745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:latest .
      - $(aws ecr get-login --region eu-west-1)
      - docker push "745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:latest"
  docker:
    branch: /feature.*/
    commands:
      - npm run builddocker
      - docker build -f docker/Dockerfile -t 745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:feature-$BRANCH .
      - $(aws ecr get-login --region eu-west-1)
      - docker push "745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:feature-$BRANCH"
  release:
    branch: /release.*/
    commands:
      - npm run buildbeta
      - aws s3 sync dist s3://web-es.beta.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-es.beta.wallapop.com/index.html --cache-control max-age=0
      - npm run buildbeta-en
      - aws s3 sync dist s3://web-en.beta.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-en.beta.wallapop.com/index.html --cache-control max-age=0
  hotfix:
    branch: /hotfix.*/
    commands:
      - npm run buildbeta
      - aws s3 sync dist s3://web-es.beta.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-es.beta.wallapop.com/index.html --cache-control max-age=0
      - npm run buildbeta-en
      - aws s3 sync dist s3://web-en.beta.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-en.beta.wallapop.com/index.html --cache-control max-age=0
  prod:
    branch: master
    commands:
      - npm run buildprod
      - aws s3 sync dist s3://web-es.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-es.wallapop.com/index.html --cache-control max-age=0
      - npm run buildprod-en
      - aws s3 sync dist s3://web-en.wallapop.com --delete
      - aws s3 cp dist/index.html s3://web-en.wallapop.com/index.html --cache-control max-age=0
      - npm run builddocker
      - docker build -f docker/Dockerfile -t 745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:stable .
      - $(aws ecr get-login --region eu-west-1)
      - docker push "745640521341.dkr.ecr.eu-west-1.amazonaws.com/devel/webapp:stable"
