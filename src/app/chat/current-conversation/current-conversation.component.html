<div id="empty-state" *ngIf="!currentConversation || loadingError">
  <div class="empty" *ngIf="emptyInbox && !loadingError">
    <div>
      <mat-icon svgIcon="empty-inbox-conversation"></mat-icon>
    </div>
  </div>
  <div class="content" *ngIf="!emptyInbox || loadingError">
    <mat-icon svgIcon="empty-state" class="image"></mat-icon>
    <p *ngIf="!emptyInbox && !connectionError && !loadingError" i18n>Choose a conversation<br/>
      from the list on the left</p>
    <p *ngIf="emptyInbox && !connectionError && !loadingError" i18n>There are no messages</p>
    <p *ngIf="connectionError || loadingError" i18n>Service not available at the moment.<br/>
      Try again later.</p>
  </div>
</div>

<div *ngIf="currentConversation && !loadingError" class="messaging-container">
  <div class="messaging">
    <div class="chat">

      <tsl-conversation-details-bar [currentConversation]="currentConversation"
                                    [isExpanded]="isTopBarExpanded"
                                    (blockUserEvent)="scrollToLastMessage()"
                                    (expandContainer)="expandTopBar($event)"
                                    [ngClass]="{expanded: isTopBarExpanded}"></tsl-conversation-details-bar>

      <div class="messages-panel-container" #scrollElement (scroll)="onScrollMessages($event)">

        <div class="empty-container"></div>

        <div class="message-container" [ngClass]="{'extra-top-padding': hasMoreMessages()}">
          <div class="notification-container" #userWarringNotification>
            <div *ngIf="currentConversation.user.blocked" class="date-marker date-marker-error">
              <mat-icon svgIcon="blocked-error"></mat-icon>
              <span i18n>You have blocked this user. Unblock it to continue chatting</span>
            </div>

            <div *ngIf="!currentConversation.user.blocked && !currentConversation.user.available"
                 class="date-marker date-marker-error">
              <mat-icon svgIcon="not-available-error"></mat-icon>
              <span i18n>This user is not available</span>
            </div>

            <div
              *ngIf="!currentConversation.user.blocked && currentConversation.user.available && currentConversation.item.notAvailable"
              class="date-marker date-marker-warning">
              <mat-icon svgIcon="not-available" class="not-available"></mat-icon>
              <span i18n>This product is not available</span>
            </div>
          </div>

          <div *ngFor="let message of currentConversation?.messages; let i = index" class="message-wrapper"
               [ngClass]="{'message-owner': message.fromSelf, 'not-message-owner': !message.fromSelf}">
            <div *ngIf="showDate(message, currentConversation.messages[i+1])" class="date-marker">
              <span *ngIf="dateIsThisYear(message.date)">{{message.date | amCalendar:momentConfig}}</span>
              <span *ngIf="!dateIsThisYear(message.date)">{{message.date | amDateFormat:'D MMM. YYYY' }}</span>
            </div>

            <tsl-text-message *ngIf="isTextMessage(message.type)" [message]="message"></tsl-text-message>
            <tsl-third-voice-drop-price *ngIf="isThirdVoiceDropPrice(message.type)"
                                        [message]="message"></tsl-third-voice-drop-price>
            <tsl-third-voice-review *ngIf="isThirdVoiceReview(message.type)"
                                    [message]="message"
                                    [user]="currentConversation.user"
                                    [item]="currentConversation.item"></tsl-third-voice-review>
          </div>

          <div class="notification-container">
            <div class="date-marker date-marker-warning date-marker-warning-blue">
              <mat-icon svgIcon="padlock-gold" class="padlock"></mat-icon>
              <span i18n="@@securityWarring">For security reasons, never share private data</span>
            </div>
          </div>

          <div *ngIf="hasMoreMessages()" class="more-messages-loader">
            <a class="load-more">
                            <span *ngIf="!isLoadingMoreMessages" (click)="loadMoreMessages(scrollElement.scrollHeight)"
                                  i18n>Load more</span>
              <mat-icon *ngIf="isLoadingMoreMessages" svgIcon="spinner" class="spinner"></mat-icon>
            </a>
          </div>
        </div>
      </div>

      <div class="scroll-message-container">
        <tsl-scrolling-message [isVisible]="!isEndOfConversation" [noMessages]="currentConversation.unreadCounter"
                               (clickScroll)="scrollToLastMessage()"></tsl-scrolling-message>
      </div>

      <div class="input send-message-container">
        <tsl-input [currentConversation]="currentConversation" (typing)="typing()"></tsl-input>
      </div>
    </div>
  </div>

  <div id="conversation-meta" class="conversation-meta d-none d-xl-block">
    <div class="card">
      <tsl-inbox-user-detail [user]="currentConversation.user" [item]="currentConversation.item"
                             [phoneNumber]="currentConversation.phoneNumber"></tsl-inbox-user-detail>
    </div>
    <tsl-inbox-item-for-sell *ngxPermissionsOnly="['isProfessional']"
                             [user]="currentConversation.user"></tsl-inbox-item-for-sell>
    <tsl-inbox-item-detail [item]="currentConversation.item"></tsl-inbox-item-detail>
    <tsl-ad slotid="div-gpt-ad-1508490196308-0"></tsl-ad>
  </div>
</div>
