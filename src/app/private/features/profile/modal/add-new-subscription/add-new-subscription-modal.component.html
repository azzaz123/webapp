<div class="AddNewSubscription__box">
  <div class="AddNewSubscription__box-header">
    <div class="modal-close" (click)="activeModal.close()">
      <tsl-svg-icon src="/assets/icons/cross.svg"></tsl-svg-icon>
    </div>
    <h4 class="AddNewSubscription__box--title" i18n="@@web_subscribe_to_pro">Subscribe to PRO</h4>
    <p class="AddNewSubscription__box--subtitle" i18n="@@web_choose_subscription">Choose a subscription and take your sales up to the next level.
    </p>
  </div>
  <ngb-carousel interval="0" *ngIf="loaded"
    [ngClass]="{ 'extra-info': subscription.category_id === carsCategoryId, 'single': subscription.tiers.length === 1 }">
    <ng-template ngbSlide *ngIf="subscription.tiers.length !== 1" id="step-1">
      <div class="step step-1">
        <div class="box-content">

          <div>
            <p class="AddNewSubscription__listing-limit-steps" i18n="@@web_step1of4">Step <span class="bold">1</span> of <span
                class="bold">4</span></p>
            <div class="AddNewSubscription__listing-limit-title" i18n="@@web_how_many_products_to_upload">How many
              {{subscription.category_name.toLowerCase()}} are you going to upload to your profile?</div>
          </div>

          <div>
            <div class="AddNewSubscription__listing-limit-container">
              <div *ngFor="let tier of subscription.tiers; let i = index"
                (click)="selectListingLimit(subscription.tiers[i])" class="AddNewSubscription__listing-limit-box"
                [ngClass]="{'AddNewSubscription__listing-limit-box--selected' : selectedTier.id === subscription.tiers[i].id}">
                <span *ngIf="subscription.tiers[i].limit">{{subscription.tiers[i].limit}}</span>
                <span *ngIf="!subscription.tiers[i].limit" i18n="@@web_unlimited">Unlimited</span>
              </div>
            </div>
            <div class="AddNewSubscription__listing-limit-more" *ngIf="subscription.category_id === carsCategoryId"
              i18n="@@web_contact_us_directly">
              Do you have more than
              {{subscription.tiers[subscription.tiers.length - 1].limit}} {{subscription.category_name.toLowerCase()}}?
              <a href="{{carDealerTypeformLink}}" target="_blank" (click)="trackClickCardealerTypeform()">Contact us directly</a>
            </div>
          </div>
          <div>
            <div class="AddNewSubscription__listing-limit-payment AddNewSubscription__listing-limit-payment--line-top">
              <div class="text-left">
                <span class="AddNewSubscription__listing-limit-quantity">
                  <span *ngIf="selectedTier.limit" i18n="@@web_category_plan">{{selectedTier.limit}} {{subscription.category_name}}
                    Plan</span>
                  <span *ngIf="!selectedTier.limit" i18n="@@web_unlimitedPlan">Unlimited {{subscription.category_name}} Plan</span>
                </span>
              </div>
              <div class="text-right">
                <div *ngIf="isFreeTier(selectedTier) && !hasTrial(subscription)" class="AddNewSubscription__free-months">
                  <b *ngIf="selectedTier.discount_available.months === 1" i18n="@@web_one_month_free">One month free</b>
                  <b *ngIf="selectedTier.discount_available.months > 1" i18n="@@web_multiple_months_free">{{selectedTier.discount_available.months}} months free</b>
                </div>
                <div *ngIf="hasTrial(subscription)" class="AddNewSubscription__free-months">
                    <b i18n="@@web_add_new_subscription_days_free">{{subscription.trial_days}} days free</b>
                  </div>
                <div *ngIf="isDiscountedTier(selectedTier) || hasTrial(subscription)" class="AddNewSubscription__price-after-discount" i18n="@@web_then_price_month">
                  Then {{selectedTier.price}}{{selectedTier.currency}}/month
                </div>
                <div *ngIf="!isDiscountedTier(selectedTier) && !hasTrial(subscription)" class="AddNewSubscription__listing-limit-price" i18n="@@web_price_month">
                  {{selectedTier.price}}{{selectedTier.currency}}/month
                </div>
              </div>
            </div>
            <tsl-button class="col-10 offset-0" className="btn-primary btn-medium payment" [disabled]="!selectedTier" (click)="carousel.next()" i18n="@@web_continue_to_invoice">
              Continue to invoice
            </tsl-button>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template ngbSlide id="step-2">
      <div class="step step-2">
        <div class="box-content">
          <div>
            <p class="AddNewSubscription__listing-limit-steps" i18n="@@web_step2of4">Step <span class="bold">2</span> of <span class="bold">4</span></p>
            <div class="AddNewSubscription__listing-limit-title" i18n="@@web_receive_invoices">Do you want to receive invoices?</div>
          </div>
          <div>
            <div class="form-group">
              <tsl-dropdown class="form-control" i18n-placeholder="@@web_profile_modal_add_new_subscription_216" placeholder="Do you need an invoice?" (selected)="onInvoiceOptionSelect($event)"
              id="invoiceOptions" [options]="invoiceOptions" [ngModel]="selectedInvoiceOption" noFilter="10">
              </tsl-dropdown>
            </div>
          </div>
          <div class="AddNewSubscription__ButtonActions">
            <tsl-button *ngIf="canContinueToPayment" class="col-10 offset-1"
            className="btn-primary btn-medium payment" [disabled]="selectedInvoiceOption === undefined"
            (click)="carousel.select('step-3'); trackClickContinueToPayment()" i18n="@@web_continue_to_payment">
              Continue to payment
            </tsl-button>
            <tsl-button class="AddNewSubscription__ButtonActions-invoice col-10 offset-1" *ngIf="canContinueToInvoice" className="btn-primary btn-medium payment"
            [disabled]="selectedInvoiceOption === undefined"
            (click)="continueToInvoice()" i18n="@@web_continue_to_invoice">
              Continue to invoice
            </tsl-button>
            <tsl-button *ngIf="canEditInvoice" class="col-10 offset-1" className="simple light" (click)="continueToInvoice()" i18n="@@web_edit_invoice">
              Edit invoice information
            </tsl-button>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template ngbSlide id="step-2b">
      <div class="step step-2b">
        <div class="box-content">
          <div class="AddNewSubscription__listing-limit-invoice">
            <p class="AddNewSubscription__listing-limit-steps" i18n="@@web_step3of4">
              Step <span class="bold">3</span> of <span class="bold">4</span></p>
            <div class="AddNewSubscription__listing-limit-title" i18n="@@web_invoice">Invoice</div>
            <div class="AddNewSubscription__listing-limit-subtitle" i18n="@@web_add_new_subscription_modal_step3_subtitle">For services other than subscriptions (e.g. visibility packs) you won't receive invoices.</div>
          </div>
          <div>
            <tsl-profile-pro-billing [containerType]="'modal'" (billingInfoFormSaved)="onBillingInfoFormSaved()">
            </tsl-profile-pro-billing>
          </div>
          <div class="AddNewSubscription__ButtonActions">
            <tsl-button
              id="AddNewSubscription__ButtonActions-payment"
              class="col-8 offset-2"
              className="btn-primary btn-medium payment"
              (click)="continueToPayment();trackClickContinueToPayment();"
              [disabled]="loading"
              [loading]="loading"
              i18n="@@web_continue_to_payment"
            >
              Continue to payment
            </tsl-button>
            <tsl-button class="col-8 offset-2" className="simple light" (click)="carousel.prev()" i18n="@@web_back_to_invoice">
              Back to invoice
            </tsl-button>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template ngbSlide id="step-3">
      <div class="step step-3">
        <div class="box-content">
          <div>
            <div *ngIf="subscription.tiers.length !== 1">
              <p class="AddNewSubscription__listing-limit-steps" i18n="@@web_step4of4">Step <span class="bold">4</span> of <span
                  class="bold">4</span></p>
            </div>
            <div class="AddNewSubscription__listing-limit-title" i18n="@@web_profile_modal_add_new_subscription_217">Add payment details</div>
          </div>
          <div class="row AddNewSubscription__listing-limit-payment">
            <div
              class="col-6 AddNewSubscription__listing-limit-selection AddNewSubscription__listing-limit-selection--left">
              <div class="AddNewSubscription__listing-limit-quantity--selected">
                <span *ngIf="selectedTier.limit" i18n="@@web_profile_modal_add_new_subscription_218">{{selectedTier.limit}} {{subscription.category_name}} Plan</span>
                <span *ngIf="!selectedTier.limit" i18n="@@web_profile_modal_add_new_subscription_219">Unlimited {{subscription.category_name}} Plan</span>
              </div>
            </div>
            <div
              class="col-6 AddNewSubscription__listing-limit-selection AddNewSubscription__listing-limit-selection--right">
              <span *ngIf="!isDiscountedTier(selectedTier) && !isFreeTier(selectedTier) && !hasTrial(subscription)"
              class="AddNewSubscription__listing-limit-price--selected"
                i18n="@@web_profile_modal_add_new_subscription_220">{{selectedTier.price}}{{selectedTier.currency}}/month</span>
              <div *ngIf="isDiscountedTier(selectedTier) && !isFreeTier(selectedTier) && !hasTrial(subscription)"
              class="AddNewSubscription__listing-limit-price--selected"
                i18n="@@web_profile_modal_add_new_subscription_221">{{selectedTier.discount_available.discounted_price}}{{selectedTier.currency}}/month</div>
              <div class="AddNewSubscription__free-months" *ngIf="isFreeTier(selectedTier) && !hasTrial(subscription)">
                <b *ngIf="selectedTier.discount_available?.months === 1" i18n="@@web_profile_modal_add_new_subscription_222">One month free</b>
                <b *ngIf="selectedTier.discount_available?.months > 1" i18n="@@web_profile_modal_add_new_subscription_223">{{selectedTier.discount_available.months}} months free</b>
              </div>
              <div *ngIf="hasTrial(subscription)" class="Subscriptions__category-info-trial">
                <div i18n="@@web_subscription_new_modal_until_date">{{0 | customCurrency}} until {{subscription.trial_days | dateUntilDay}}</div>
              </div>
              <div *ngIf="isDiscountedTier(selectedTier) || isFreeTier(selectedTier) || hasTrial(subscription)"
                class="AddNewSubscription__price-after-discount" i18n="@@web_profile_modal_add_new_subscription_224">Then {{selectedTier.price}}{{selectedTier.currency}}/month</div>
              <div *ngIf="subscription.tiers.length !== 1" class="AddNewSubscription__listing-limit-payment-edit"
                (click)="carousel.select('step-1')" i18n="@@web_profile_modal_add_new_subscription_225">Change</div>
            </div>
          </div>
          <div>
            <div class="w-100 h-100 align-items-center"
              [ngClass]="{'AddNewSubscription__selection-container--with-saved-card': savedCard}">
              <div>
                <tsl-stripe-card-selection *ngIf="hasSavedCard && savedCard"
                  (onSelectExistingCard)="setSavedCard($event)" (hasCard)="hasCard($event)"></tsl-stripe-card-selection>
              </div>
              <div class="AddNewSubscription__payment-add-card" (click)="addNewCard()" *ngIf="savedCard" i18n="@@web_profile_modal_add_new_subscription_226">+ Add
                another credit card</div>
              <tsl-stripe-card-element *ngIf="showCard" [newLoading]="loading" [disabled]="!!paymentError"
                [type]="'subscription'" [listingLimit]="selectedTier" [spaceBetween]="true" [action]="action"
                [showUseSavedCard]="hasSavedCard" [paymentError]="paymentError"
                (onClickUseSavedCard)="removeNewCard()" (onFocusCard)="paymentError = null"
                (onStripeCardCreate)="addSubscription($event); trackClickPay(true);" (stripeCard)="setCardInfo($event)">
              </tsl-stripe-card-element>

              <div [hidden]="!savedCard" class="AddNewSubscription__legal-info" i18n="@@web_profile_modal_add_new_subscription_227">                By subscribing, you are accepting the <a href="{{termsAndConditionsURL}}" target="_blank">terms & conditions</a>
                and the <a href="{{privacyPolicyURL}}" target="_blank">privacy policy</a> of Wallapop S.L. and Stripe Ltd
            </div>
              <tsl-button [hidden]="!savedCard" [ngStyle]="{'pointer-events': !selectedCard || loading ? 'none' : 'auto' }" [disabled]="!selectedCard || loading" [loading]="loading"
                (click)="addSubscriptionFromSavedCard(); trackClickPay(false);" id="qa-checkout-subscription"
                className="btn-primary btn-medium stripe">
                  <div *ngIf="!hasTrial(subscription)">
                    <span *ngIf="!isDiscountedTier(selectedTier)" i18n="@@web_profile_modal_add_new_subscription_228">Pay {{selectedTier.price}}{{selectedTier.currency}}</span>
                    <span *ngIf="isDiscountedTier(selectedTier)" i18n="@@web_profile_modal_add_new_subscription_229">Pay {{selectedTier.discount_available.discounted_price}}{{selectedTier.currency}}</span>
                  </div>
                  <div *ngIf="hasTrial(subscription)">
                    <span i18n="@@web_add_new_modal_subscribe_now">Try the {{subscription?.trial_days}}-day trial for free!</span>
                  </div>
              </tsl-button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ngb-carousel>
</div>
